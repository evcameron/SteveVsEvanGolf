<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whistle Post Cup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .score-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); border-left-width: 5px; }
        
        .bg-evan-win  { background: linear-gradient(to right, #bae6fd, #ffffff); } 
        .bg-steve-win { background: linear-gradient(to right, #ffffff, #d1fae5); } 
        .bg-draw      { background: radial-gradient(circle, #fef9c3 0%, #ffffff 80%); } 

        .border-par3     { border-left-color: #94a3b8; }
        .border-18hole   { border-left-color: #3b82f6; }
        .border-9hole    { border-left-color: #8b5cf6; }
        
        .major-card { border: 1px solid #fbbf24 !important; border-left-width: 5px !important; }
        .major-header { background: #fbbf24; color: #78350f; }

        .header-bg { background-color: #052e16; } 
        .header-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(4px); color: white; }
        
        #breakdown-container { transition: max-height 0.3s ease-out, opacity 0.2s ease-in-out; overflow: hidden; }
        .collapsed { max-height: 0 !important; opacity: 0; pointer-events: none; }
        .expanded { max-height: 1200px; opacity: 1; }
        .chevron { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
        
        .points-divider { border-bottom: 2px solid rgba(255, 255, 255, 0.15); margin: 12px 0; }
        .category-row { cursor: pointer; transition: all 0.2s; border-radius: 4px; margin: 0 -4px; padding: 2px 4px; position: relative; z-index: 10; border: 1px solid transparent; }
        .category-row:hover { background: rgba(255,255,255,0.08); }
        .category-row.active-filter { background: rgba(59, 130, 246, 0.25); border: 1px solid rgba(59, 130, 246, 0.4); }

        .year-dropdown { position: relative; display: inline-block; }
        .year-menu { 
            position: absolute; right: 0; top: 110%; background: #1e293b; 
            border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; 
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); z-index: 50;
            min-width: 80px; display: none;
        }
        .year-menu.show { display: block; }
        .year-item { padding: 8px 12px; cursor: pointer; color: white; font-weight: bold; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .year-item:hover { background: rgba(255,255,255,0.1); }

        .ryder-bar-container { height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden; position: relative; }
        .evan-progress-dark  { height: 100%; background: #1d4ed8; transition: width 1s ease-in-out; float: left; }
        .steve-progress-dark  { height: 100%; background: #047857; transition: width 1s ease-in-out; float: right; }
        .evan-progress-light { height: 100%; background: repeating-linear-gradient(45deg, #60a5fa, #60a5fa 4px, #3b82f6 4px, #3b82f6 8px); transition: width 1s ease-in-out; float: left; }
        .steve-progress-light { height: 100%; background: repeating-linear-gradient(45deg, #34d399, #34d399 4px, #10b981 4px, #10b981 8px); transition: width 1s ease-in-out; float: right; }
        .mid-line { position: absolute; left: 50%; top: 0; bottom: 0; width: 2px; background: rgba(255,255,255,0.3); transform: translateX(-50%); z-index: 5; }

        .chart-container { width: 100%; position: relative; overflow: visible; }
        .chart-point { position: absolute; width: 8px; height: 8px; border-radius: 50%; transform: translate(-50%, -50%); z-index: 50; transition: all 0.2s ease; cursor: pointer; pointer-events: auto; }
        .chart-point:hover { scale: 1.4; filter: brightness(1.2); }
        .chart-line { position: absolute; height: 1.5px; transform-origin: left center; z-index: 5; pointer-events: none; }
        
        .major-point-ring { box-shadow: 0 0 0 2px #fbbf24, 0 0 10px rgba(251, 191, 36, 0.4); z-index: 60; }

        .chart-guide-line { position: absolute; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.05); pointer-events: none; }
        .chart-guide-label { position: absolute; right: 4px; font-size: 7px; font-weight: 900; color: rgba(255,255,255,0.15); text-transform: uppercase; transform: translateY(-50%); pointer-events: none; }
        .zero-guide-line { background: rgba(255,255,255,0.15) !important; }

        #point-popup { 
            position: fixed; display: none; background: rgba(15, 23, 42, 0.98); 
            border: 1px solid rgba(255, 255, 255, 0.3); backdrop-filter: blur(12px);
            padding: 12px; border-radius: 8px; z-index: 200; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.7);
            width: 180px; pointer-events: none;
        }

        #analytics-modal { display: none; position: fixed; inset: 0; z-index: 100; background: rgba(5, 46, 22, 0.98); backdrop-filter: blur(15px); }
        #analytics-modal.show { display: flex; }

        .manage-data-btn {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #0f172a; color: white; border: 1px solid #059669;
            padding: 10px 20px; border-radius: 99px; font-weight: 900; font-size: 10px;
            text-transform: uppercase; letter-spacing: 0.1em; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
            display: flex; align-items: center; gap: 8px; z-index: 40; transition: all 0.2s;
        }

        .milestone-card {
            background: rgba(30, 41, 59, 0.05);
            border-left: 2px solid rgba(59, 130, 246, 0.2);
            padding: 6px 12px; margin: 8px 0; border-radius: 2px 6px 6px 2px;
        }
        .milestone-text { color: #64748b; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.025em; font-style: italic; }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900 text-[13px] pb-24" onclick="closePopup()">

    <div id="point-popup">
        <p id="popup-date" class="text-[7px] font-black text-white/40 uppercase tracking-widest mb-1"></p>
        <p id="popup-comment" class="text-[10px] font-normal text-white italic uppercase leading-tight mb-2"></p>
        <div class="flex justify-between items-center border-t border-white/10 pt-1.5">
            <span class="text-[8px] font-bold text-white/60 uppercase">New Standings</span>
            <span id="popup-spread" class="text-[9px] font-black px-1.5 py-0.5 rounded italic"></span>
        </div>
    </div>

    <div id="analytics-modal" class="p-6 flex-col overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-white text-xl font-black uppercase italic tracking-tighter">Season Deep Dive</h2>
            <button onclick="closeModal()" class="text-white/50 hover:text-white bg-white/10 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <div class="space-y-8 max-w-sm mx-auto w-full pb-10">
            <div class="relative">
                <p class="text-[10px] font-black text-green-400 tracking-[0.2em] uppercase mb-3">Overall Points Narrative</p>
                <div id="modal-chart-overall" class="chart-container h-44 border-b border-white/5 bg-white/5 rounded-lg mb-2"></div>
                <div class="flex justify-between mt-2 text-[8px] font-bold text-white/40 uppercase tracking-widest px-1">
                    <span>Season Start</span>
                    <span>Current Day</span>
                </div>
            </div>

            <div class="grid gap-6 pt-4 border-t border-white/10">
                <p class="text-[10px] font-black text-green-400 tracking-[0.2em] uppercase">Win Momentum by Type</p>
                <div>
                    <div class="flex justify-between text-[10px] font-bold text-white mb-2 uppercase opacity-80"><span>Par 3 Lead</span><span id="stat-par3">--</span></div>
                    <div id="modal-chart-par3" class="chart-container h-24 border-b border-white/5 bg-white/5 rounded-lg"></div>
                </div>
                <div>
                    <div class="flex justify-between text-[10px] font-bold text-white mb-2 uppercase opacity-80"><span>18 Hole Lead</span><span id="stat-18hole">--</span></div>
                    <div id="modal-chart-18hole" class="chart-container h-24 border-b border-white/5 bg-white/5 rounded-lg"></div>
                </div>
                <div>
                    <div class="flex justify-between text-[10px] font-bold text-white mb-2 uppercase opacity-80"><span>9 Hole Lead</span><span id="stat-9hole">--</span></div>
                    <div id="modal-chart-9hole" class="chart-container h-24 border-b border-white/5 bg-white/5 rounded-lg"></div>
                </div>
            </div>
        </div>
    </div>

    <header class="header-bg shadow-2xl pt-4 pb-3 sticky top-0 z-20">
        <div class="max-w-sm mx-auto px-4">
            <div class="flex items-end justify-between mb-3">
                <h1 class="flex flex-col leading-none">
                    <span class="text-[9px] font-bold tracking-[0.4em] text-green-400 uppercase mb-0.5">The Annual</span>
                    <span class="text-2xl font-black uppercase tracking-tighter italic text-white">
                        Whistle Post <span class="text-green-400 not-italic font-light">CUP</span>
                    </span>
                </h1>
                
                <div class="year-dropdown">
                    <button onclick="toggleYearMenu(event)" class="border border-white/30 bg-black/20 px-2 py-0.5 rounded text-[11px] font-black italic tracking-tighter text-white flex items-center gap-1">
                        <span id="display-year">2026</span>
                        <svg class="w-2 h-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="year-menu" class="year-menu"></div>
                </div>
            </div>
            
            <div class="flex flex-col gap-2">
                <div class="header-card rounded-xl p-4 shadow-lg text-center">
                    <div class="flex justify-between items-end mb-2">
                        <div class="text-left w-20">
                            <span class="block text-[10px] font-black uppercase opacity-60 text-white leading-none mb-1">Evan</span>
                            <span id="evan-points" class="text-3xl font-black text-blue-400 leading-none">--</span>
                        </div>
                        <div class="flex-grow pb-1">
                             <span class="text-[8px] font-black uppercase opacity-40 text-white tracking-[0.2em]">Current Standings</span>
                        </div>
                        <div class="text-right w-20">
                            <span class="block text-[10px] font-black uppercase opacity-60 text-white leading-none mb-1">Steve</span>
                            <span id="steve-points" class="text-3xl font-black text-emerald-400 leading-none">--</span>
                        </div>
                    </div>
                    
                    <div class="ryder-bar-container mb-2">
                        <div class="mid-line"></div>
                        <div id="evan-bar-dark" class="evan-progress-dark" style="width: 0%"></div>
                        <div id="evan-bar-light" class="evan-progress-light" style="width: 0%"></div>
                        <div id="steve-bar-dark" class="steve-progress-dark" style="width: 0%"></div>
                        <div id="steve-bar-light" class="steve-progress-light" style="width: 0%"></div>
                    </div>

                    <div class="flex justify-between text-[8px] font-black uppercase tracking-wider">
                        <span id="evan-wins-stat" class="text-blue-300/60">-- Wins</span>
                        <span class="text-white/20">Target: 50.5</span>
                        <span id="steve-wins-stat" class="text-emerald-300/60">-- Wins</span>
                    </div>
                </div>

                <div id="main-breakdown-card" class="header-card rounded-xl px-3 py-2 text-left transition-colors">
                    <div class="w-full flex justify-between items-center cursor-pointer" onclick="toggleBreakdown()">
                        <p class="text-[9px] uppercase tracking-[0.2em] font-black opacity-40 text-white">Analytics & Breakdown</p>
                        <div class="bg-white/10 p-1 rounded-md">
                            <svg id="chevron-icon" class="chevron rotate-180 w-3 h-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 9l-7 7-7-7"></path>
                            </svg>
                        </div>
                    </div>
                    <div id="breakdown-container" class="collapsed">
                        <div class="mt-4 px-1 cursor-pointer" onclick="openModal()">
                            <div class="flex justify-between items-end mb-1">
                                <p class="text-[8px] font-black opacity-30 text-white tracking-widest uppercase">Overall YTD Points Lead</p>
                            </div>
                            <div id="season-chart" class="chart-container h-[90px]"></div>
                        </div>

                        <div class="pt-3 mb-2 flex text-[7px] uppercase font-black opacity-30 border-b border-white/5 pb-1 text-white">
                            <span class="flex-grow">CATEGORY</span>
                            <div class="flex w-52 text-center">
                                <span class="w-12">EVAN</span>
                                <span class="w-12 border-r border-white/5">STEVE</span>
                                <span class="w-12 ml-1">EVAN W</span>
                                <span class="w-12">STEVE W</span>
                            </div>
                        </div>
                        <div id="breakdown-list" class="space-y-1.5 text-[10px] font-bold uppercase text-white"></div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-md mx-auto p-3">
        <div id="filter-status" class="hidden mb-3 flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 shadow-sm">
            <span class="text-[10px] font-bold text-blue-700 uppercase tracking-wider">Filtered: <span id="active-filter-name">None</span></span>
            <button onclick="resetFilter()" class="text-[9px] font-black text-white bg-blue-600 px-2.5 py-1 rounded hover:bg-blue-700 uppercase transition-colors">Clear</button>
        </div>
        <div id="results-list" class="space-y-3 pt-2">
            <p class="text-center py-10 text-slate-400 italic">Accessing Season Records...</p>
        </div>
    </main>

    <a href="https://docs.google.com/spreadsheets/d/1M4FJ7Nfk9rLcPoUvmDHnOp-PHfUfKgbJjYl8LSvyF1Q/edit?usp=sharing" target="_blank" class="manage-data-btn">
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
        Manage Data
    </a>

    <script>
        let CONFIG = { WebsiteYear: "2026" };
        const MATCHES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgE990XAIusYwh-kIJw35ZMFn7_886JopnebL0YFuGCDXVF7wUtIwolZuCZXY62AjBJM2Y7fLhoI-l/pub?output=csv&gid=0';
        const DETAILS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgE990XAIusYwh-kIJw35ZMFn7_886JopnebL0YFuGCDXVF7wUtIwolZuCZXY62AjBJM2Y7fLhoI-l/pub?gid=1591713882&single=true&output=csv';

        let allMatches = []; 
        let availableYears = new Set();
        let activeFilter = null;

        function toggleYearMenu(e) { e.stopPropagation(); document.getElementById('year-menu').classList.toggle('show'); }
        function closePopup() { 
            document.getElementById('year-menu').classList.remove('show');
            document.getElementById('point-popup').style.display = 'none';
        }

        function changeYear(year) {
            CONFIG.WebsiteYear = year;
            document.getElementById('display-year').innerText = year;
            resetFilter();
            refreshData();
        }

        function toggleBreakdown() {
            const container = document.getElementById('breakdown-container');
            const icon = document.getElementById('chevron-icon');
            container.classList.toggle('expanded');
            container.classList.toggle('collapsed');
            icon.classList.toggle('rotate-180');
        }

        function openModal() {
            document.getElementById('analytics-modal').classList.add('show');
            const chronMatches = [...allMatches].reverse();
            
            const pointsHistory = chronMatches.map(m => ({
                val: (parseFloat(m[20]) || 0) - (parseFloat(m[21]) || 0),
                isMajor: isMajorRound(m[3]),
                comment: m[23] ? m[23].replace(/"/g, '').trim() : "",
                date: m[1] || "",
                course: m[4] || "",
                played: true
            }));
            renderSparkline('modal-chart-overall', pointsHistory, 176, true, false);

            const p3History = getAlignedHistory(chronMatches, 'par 3');
            renderSparkline('modal-chart-par3', p3History, 96, true, false);
            updateStatLabel('stat-par3', p3History.map(h => h.val));

            const h18History = getAlignedHistory(chronMatches, '18');
            renderSparkline('modal-chart-18hole', h18History, 96, true, false);
            updateStatLabel('stat-18hole', h18History.map(h => h.val));

            const h9History = getAlignedHistory(chronMatches, '9');
            renderSparkline('modal-chart-9hole', h9History, 96, true, false);
            updateStatLabel('stat-9hole', h9History.map(h => h.val));
        }

        function isMajorRound(colVal) {
            if (!colVal) return false;
            const clean = colVal.replace(/"/g, '').trim();
            return clean !== "" && clean.length > 0;
        }

        function getAlignedHistory(matches, keyword) {
            let runningDiff = 0;
            return matches.map(m => {
                const cat = m[2].toLowerCase();
                const isMajor = isMajorRound(m[3]);
                let isMatch = false;

                if (keyword === '9') {
                   if (cat.includes('9') && !cat.includes('18')) isMatch = true;
                } else if (cat.includes(keyword)) {
                   isMatch = true;
                }

                if (isMatch) {
                    const winner = m[9].toLowerCase();
                    // In sub-charts, everything is worth 1 win point
                    if (winner.includes('evan')) runningDiff += 1;
                    else if (winner.includes('steve')) runningDiff -= 1;
                }
                
                return {
                    val: runningDiff,
                    isMajor: isMajor,
                    date: m[1],
                    course: m[4],
                    comment: m[23] ? m[23].replace(/"/g, '').trim() : "",
                    played: isMatch
                };
            });
        }

        function updateStatLabel(id, history) {
            const last = history[history.length - 1] || 0;
            document.getElementById(id).innerText = last > 0 ? `Evan +${last}` : last < 0 ? `Steve +${Math.abs(last)}` : `Even`;
        }

        function closeModal() { document.getElementById('analytics-modal').classList.remove('show'); }

        function showPointPopup(e, point) {
            e.stopPropagation();
            const popup = document.getElementById('point-popup');
            const dateEl = document.getElementById('popup-date');
            const commentEl = document.getElementById('popup-comment');
            const spreadEl = document.getElementById('popup-spread');

            dateEl.innerText = `${point.date} ‚Ä¢ ${point.course}`;
            commentEl.innerText = point.comment || "No Lead Change";
            
            const spread = point.val;
            spreadEl.innerText = spread > 0 ? `Evan +${spread}` : spread < 0 ? `Steve +${Math.abs(spread)}` : `Even`;
            spreadEl.className = `text-[9px] font-black px-1.5 py-0.5 rounded italic ${spread > 0 ? 'bg-blue-600 text-white' : spread < 0 ? 'bg-emerald-600 text-white' : 'bg-white/10 text-white'}`;

            popup.style.display = 'block';
            let left = e.clientX + 10;
            let top = e.clientY - 40;
            if (left + 180 > window.innerWidth) left = e.clientX - 190;
            popup.style.left = `${left}px`;
            popup.style.top = `${top}px`;
        }

        function renderSparkline(containerId, dataPoints, height, interactive, isMainPage) {
            const chart = document.getElementById(containerId);
            const zeroLine = height / 2;
            const PADDING = 20;
            chart.innerHTML = '';
            
            if (dataPoints.length < 1) {
                chart.innerHTML += `<div class="flex items-center justify-center h-full text-white/20 text-[10px] uppercase font-bold">Waiting for Rounds...</div>`;
                return;
            }

            const vals = dataPoints.map(d => d.val);
            const absMax = Math.max(Math.max(...vals.map(Math.abs)), 1);
            const stepX = dataPoints.length > 1 ? 100 / (dataPoints.length - 1) : 50;

            const drawScaleLine = (val, label) => {
                const yPos = zeroLine - (val * ((height / 2 - PADDING) / absMax));
                const line = document.createElement('div');
                line.className = `chart-guide-line ${val === 0 ? 'zero-guide-line' : ''}`;
                line.style.top = `${yPos}px`;
                chart.appendChild(line);
                if (label && !isMainPage) {
                    const lbl = document.createElement('div');
                    lbl.className = 'chart-guide-label';
                    lbl.style.top = `${yPos}px`;
                    lbl.innerText = label;
                    chart.appendChild(lbl);
                }
            };

            drawScaleLine(absMax, `+${absMax}`);
            drawScaleLine(0, 'Even');
            drawScaleLine(-absMax, `-${absMax}`);

            dataPoints.forEach((point, i) => {
                const x = dataPoints.length > 1 ? i * stepX : 50;
                const y = zeroLine - (point.val * ((height / 2 - PADDING) / absMax));
                
                if (isMainPage || point.played) {
                    const dot = document.createElement('div');
                    const baseColorClass = point.val > 0 ? 'bg-blue-400' : point.val < 0 ? 'bg-emerald-400' : 'bg-white';
                    const glowClass = point.val > 0 ? 'shadow-[0_0_8px_#60a5fa]' : point.val < 0 ? 'shadow-[0_0_8px_#34d399]' : '';
                    dot.className = `chart-point ${baseColorClass} ${glowClass} ${point.isMajor ? 'major-point-ring' : ''}`;
                    dot.style.left = `${x}%`;
                    dot.style.top = `${y}px`;
                    if (interactive) dot.addEventListener('click', (e) => showPointPopup(e, point));
                    chart.appendChild(dot);
                }

                if (i < dataPoints.length - 1) {
                    const nextVal = dataPoints[i+1].val;
                    const nextX = (i + 1) * stepX;
                    const nextY = zeroLine - (nextVal * ((height / 2 - PADDING) / absMax));
                    const dx = (nextX - x) * (chart.clientWidth / 100);
                    const dy = nextY - y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    const line = document.createElement('div');
                    line.className = 'chart-line bg-white/10';
                    line.style.width = `${dist}px`;
                    line.style.left = `${x}%`;
                    line.style.top = `${y}px`;
                    line.style.transform = `rotate(${angle}deg)`;
                    chart.appendChild(line);
                }
            });
        }

        async function fetchOverallDetails() {
            try {
                const response = await fetch(DETAILS_URL + '&cb=' + new Date().getTime());
                const data = await response.text();
                const rows = data.split(/\r?\n/).map(row => row.split(','));
                const list = document.getElementById('breakdown-list');
                list.innerHTML = '';
                let evTotal = 0, stTotal = 0, evMajorPts = 0, stMajorPts = 0, tournamentCount = 0;
                rows.forEach(col => {
                    const rowYear = col[5]?.replace(/"/g, '').trim(); 
                    if (rowYear && rowYear !== "Year") availableYears.add(rowYear);
                    const label = col[3]?.replace(/"/g, '').trim(); 
                    if (!label || label === "Category" || label === "" || rowYear !== CONFIG.WebsiteYear) return;
                    const type = col[0]?.replace(/"/g, '').trim().toLowerCase();
                    const isMajor = type.includes('major');
                    const evPts = parseFloat(col[6]?.replace(/"/g, '').trim()) || 0;
                    const stPts = parseFloat(col[7]?.replace(/"/g, '').trim()) || 0;
                    const evWins = col[8]?.replace(/"/g, '').trim(), stWins = col[9]?.replace(/"/g, '').trim();
                    if (label.toLowerCase() === 'total') {
                        evTotal = evPts; stTotal = stPts;
                        document.getElementById('evan-points').innerText = evTotal;
                        document.getElementById('steve-points').innerText = stTotal;
                    } else {
                        tournamentCount++;
                        if (isMajor) { evMajorPts += evPts; stMajorPts += stPts; }
                        list.innerHTML += `<div onclick="applyFilter('${label}', this, event)" class="category-row flex items-center border-b border-white/5 pb-1">
                                <div class="flex-grow truncate pr-1"><span class="opacity-70 truncate">${label}</span></div>
                                <div class="flex w-52 text-center items-center flex-shrink-0">
                                    <span class="w-12 text-blue-500 font-black">${evPts}</span>
                                    <span class="w-12 text-emerald-500 font-black border-r border-white/10">${stPts}</span>
                                    <span class="w-12 ml-1 text-blue-300/60 text-[8px]">${isMajor ? '' : evWins+'w'}</span>
                                    <span class="w-12 text-emerald-300/60 text-[8px]">${isMajor ? '' : stWins+'w'}</span>
                                </div>
                            </div>`;
                        if (tournamentCount === 3) list.innerHTML += `<div class="points-divider"></div>`;
                    }
                });
                const target = 100;
                document.getElementById('evan-bar-dark').style.width = (evMajorPts / target * 100) + '%';
                document.getElementById('evan-bar-light').style.width = ((evTotal - evMajorPts) / target * 100) + '%';
                document.getElementById('steve-bar-dark').style.width = (stMajorPts / target * 100) + '%';
                document.getElementById('steve-bar-light').style.width = ((stTotal - stMajorPts) / target * 100) + '%';
                populateYearMenu();
            } catch (e) { console.error(e); }
        }

        async function fetchMatchResults() {
            try {
                const response = await fetch(MATCHES_URL + '&cb=' + new Date().getTime());
                const data = await response.text();
                const rows = data.split(/\r?\n/).map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
                allMatches = rows.slice(1).reverse().filter(col => col[0]?.replace(/"/g, '').trim() === CONFIG.WebsiteYear);
                renderMatches();
                updateStats();
                const chronMatches = [...allMatches].reverse();
                const pointsHistory = chronMatches.map(m => ({
                    val: (parseFloat(m[20]) || 0) - (parseFloat(m[21]) || 0),
                    isMajor: isMajorRound(m[3]),
                    comment: m[23] ? m[23].replace(/"/g, '').trim() : "" 
                }));
                renderSparkline('season-chart', pointsHistory, 90, false, true);
            } catch (e) { console.error(e); }
        }

        function renderMatches() {
            const container = document.getElementById('results-list');
            container.innerHTML = '';
            const filtered = activeFilter ? allMatches.filter(col => col[2]?.trim() === activeFilter || col[3]?.trim() === activeFilter) : allMatches;
            if (filtered.length === 0) { container.innerHTML = `<p class="text-center py-10 text-slate-400">No records found.</p>`; return; }
            filtered.forEach(col => {
                const dateStr = col[1]?.trim(), cat = col[2]?.trim(), maj = col[3]?.trim(), course = col[4]?.trim();
                const evS = col[5]?.trim(), stS = col[6]?.trim(), evH = col[7]?.trim() || "0", stH = col[8]?.trim() || "0", winnerText = col[9]?.trim().toLowerCase();
                const sparkComment = col[22] ? col[22].replace(/"/g, '').trim() : "";
                const matchComment = col[23] ? col[23].replace(/"/g, '').trim() : "";
                const isEvW = winnerText.includes('evan'), isStW = winnerText.includes('steve');
                let catClass = cat.toLowerCase().includes('par 3') ? 'border-par3' : (cat.toLowerCase().includes('18') ? 'border-18hole' : 'border-9hole');
                let html = `<div class="flex flex-col">`;
                if (sparkComment) html += `<div class="milestone-card"><p class="milestone-text">${sparkComment}</p></div>`;
                if (isMajorRound(maj)) html += `<div class="flex justify-start pl-4 mt-2"><span class="major-header text-[9px] font-black px-3 py-1 rounded-t-lg uppercase italic tracking-widest shadow-sm">üèÜ ${maj}</span></div>`;
                html += `<div class="score-card px-3 py-2 flex flex-col ${catClass} ${isEvW ? 'bg-evan-win' : (isStW ? 'bg-steve-win' : 'bg-draw')} ${isMajorRound(maj) ? 'major-card' : ''}">
                            <div class="flex justify-between items-center mb-1 border-b border-slate-200 pb-1 text-slate-500">
                                <span class="text-[9px] font-bold uppercase">${dateStr} ‚Ä¢ ${course}</span>
                                <span class="text-[9px] font-bold uppercase">${cat}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-2 w-[42%]"><span class="font-black text-[10px] ${isEvW ? 'text-blue-800' : 'text-slate-400'}">EVAN</span><span class="text-xl font-black ${isEvW ? 'text-slate-900' : 'text-slate-400'}">${evH} <span class="text-[9px] font-bold opacity-60 ml-0.5">(${evS})</span></span></div>
                                <span class="text-slate-300 italic font-bold text-[10px]">VS</span>
                                <div class="flex items-center justify-end gap-2 w-[42%] text-right"><span class="text-xl font-black ${isStW ? 'text-slate-900' : 'text-slate-400'}"><span class="text-[9px] font-bold opacity-60 mr-0.5">(${stS})</span> ${stH}</span><span class="font-black text-[10px] ${isStW ? 'text-emerald-800' : 'text-slate-400'}">STEVE</span></div>
                            </div>
                            ${matchComment ? `<div class="mt-2 text-[9px] italic text-slate-500 border-t border-slate-100 pt-1">${matchComment}</div>` : ''}
                        </div>
                    </div>`;
                container.innerHTML += html;
            });
        }

        function updateStats() {
            let eW = 0, sW = 0;
            allMatches.forEach(col => {
                const w = col[9]?.toLowerCase();
                if (w.includes('evan')) eW++; else if (w.includes('steve')) sW++;
            });
            document.getElementById('evan-wins-stat').innerText = `${eW} Wins`;
            document.getElementById('steve-wins-stat').innerText = `${sW} Wins`;
        }

        function applyFilter(cat, el, e) {
            e.stopPropagation();
            if (activeFilter === cat) { resetFilter(); return; }
            document.querySelectorAll('.category-row').forEach(r => r.classList.remove('active-filter'));
            el.classList.add('active-filter');
            activeFilter = cat;
            document.getElementById('active-filter-name').innerText = cat;
            document.getElementById('filter-status').classList.remove('hidden');
            renderMatches();
            document.getElementById('filter-status').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function resetFilter() {
            activeFilter = null;
            document.querySelectorAll('.category-row').forEach(r => r.classList.remove('active-filter'));
            document.getElementById('filter-status').classList.add('hidden');
            renderMatches();
        }

        function populateYearMenu() {
            const menu = document.getElementById('year-menu');
            menu.innerHTML = '';
            Array.from(availableYears).sort().reverse().forEach(year => {
                menu.innerHTML += `<div class="year-item" onclick="changeYear('${year}')">${year}</div>`;
            });
        }

        function refreshData() { fetchOverallDetails(); fetchMatchResults(); }
        refreshData();
    </script>
</body>
</html>
