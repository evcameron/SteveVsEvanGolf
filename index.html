<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whistle Post Cup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .score-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); transition: all 0.2s; }
        .evan-win { border-left: 4px solid #3b82f6; }
        .steve-win { border-left: 4px solid #10b981; }
        .major-card { border: 2px solid #fbbf24; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2); }
        .major-header { background: #fbbf24; color: #78350f; }
        .header-card { 
            background: rgba(255, 255, 255, 0.1); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-slate-100 font-sans text-slate-900 text-[13px]">

    <header class="bg-green-800 text-white p-4 text-center shadow-lg sticky top-0 z-20">
        <h1 class="text-xl font-black uppercase italic tracking-tighter mb-3">Whistle Post Cup</h1>
        
        <div class="grid grid-cols-2 gap-2 max-w-sm mx-auto mb-3">
            <div class="header-card rounded-lg p-2">
                <p class="text-[8px] uppercase tracking-widest font-bold opacity-70 mb-1">Cup Totals</p>
                <div class="flex justify-around items-center">
                    <div class="text-center">
                        <span class="block text-[9px] font-bold uppercase opacity-60">Evan</span>
                        <span id="evan-points" class="text-base font-black text-blue-300">--</span>
                    </div>
                    <div class="text-center">
                        <span class="block text-[9px] font-bold uppercase opacity-60">Steve</span>
                        <span id="steve-points" class="text-base font-black text-emerald-300">--</span>
                    </div>
                </div>
            </div>

            <div class="header-card rounded-lg p-2 overflow-hidden">
                <p class="text-[8px] uppercase tracking-widest font-bold opacity-70 mb-1 text-left">Category Breakdown</p>
                <div id="breakdown-list" class="space-y-0.5 text-[8px] font-bold uppercase text-left">
                    </div>
            </div>
        </div>

        <div id="standings" class="flex justify-center gap-3 text-[10px] font-bold uppercase tracking-widest opacity-90"></div>
    </header>

    <main class="max-w-md mx-auto p-3">
        <div id="results-list" class="space-y-3">
            <p class="text-center py-10 text-slate-400 font-medium italic">Syncing scores...</p>
        </div>
    </main>

    <script>
        const MATCHES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgE990XAIusYwh-kIJw35ZMFn7_886JopnebL0YFuGCDXVF7wUtIwolZuCZXY62AjBJM2Y7fLhoI-l/pub?output=csv&gid=0';
        const DETAILS_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTgE990XAIusYwh-kIJw35ZMFn7_886JopnebL0YFuGCDXVF7wUtIwolZuCZXY62AjBJM2Y7fLhoI-l/pub?gid=1591713882&single=true&output=csv';

        async function fetchOverallDetails() {
            try {
                const response = await fetch(DETAILS_URL + '&cb=' + new Date().getTime());
                const data = await response.text();
                const rows = data.split(/\r?\n/).map(row => row.split(','));

                const breakdownList = document.getElementById('breakdown-list');
                breakdownList.innerHTML = '';

                rows.forEach(col => {
                    const label = col[3]?.replace(/"/g, '').trim();
                    const evanVal = col[6]?.replace(/"/g, '').trim();
                    const steveVal = col[7]?.replace(/"/g, '').trim();

                    if (!label || label === "Category" || label === "") return;

                    // If it's the TOTAL row, update the totals card
                    if (label.toLowerCase() === 'total') {
                        document.getElementById('evan-points').innerText = evanVal;
                        document.getElementById('steve-points').innerText = steveVal;
                    } 
                    // Otherwise, add it to the breakdown list
                    else {
                        breakdownList.innerHTML += `
                            <div class="flex justify-between border-b border-white/10 pb-0.5">
                                <span class="opacity-60 truncate mr-1">${label}</span>
                                <span class="whitespace-nowrap">
                                    <span class="text-blue-300">${evanVal}</span> / <span class="text-emerald-300">${steveVal}</span>
                                </span>
                            </div>`;
                    }
                });
            } catch (e) { console.error(e); }
        }

        async function fetchMatchResults() {
            try {
                const response = await fetch(MATCHES_URL + '&cb=' + new Date().getTime());
                const data = await response.text();
                const rows = data.split(/\r?\n/).map(row => row.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/));
                const container = document.getElementById('results-list');
                const standingsEl = document.getElementById('standings');
                container.innerHTML = '';
                let evWins = 0, stWins = 0;

                rows.slice(1).reverse().forEach(col => {
                    if (col.length < 7) return;
                    const date = col[1]?.replace(/"/g, '').trim();
                    const category = col[2]?.replace(/"/g, '').trim();
                    const majorName = col[3]?.replace(/"/g, '').trim();
                    const isMajor = majorName.length > 0;
                    const course = col[4]?.replace(/"/g, '').trim();
                    const evanS = parseInt(col[5]), steveS = parseInt(col[6]);
                    const evanH = col[7]?.trim() || "0", steveH = col[8]?.trim() || "0";
                    const winner = col[9]?.replace(/"/g, '').trim().toLowerCase();

                    if (isNaN(evanS) || isNaN(steveS)) return;
                    if (winner.includes('evan')) evWins++; else if (winner.includes('steve')) stWins++;
                    const isEvW = winner.includes('evan'), isStW = winner.includes('steve');

                    container.innerHTML += `
                        <div class="flex flex-col">
                            ${isMajor ? `<div class="flex"><span class="major-header text-[9px] font-black px-2 py-0.5 rounded-t-md uppercase tracking-wider ml-1 italic">üèÜ ${majorName}</span></div>` : ''}
                            <div class="score-card px-3 py-2 flex flex-col ${isEvW ? 'evan-win' : (isStW ? 'steve-win' : '')} ${isMajor ? 'major-card' : ''}">
                                <div class="flex justify-between items-center mb-1 border-b border-slate-50 pb-1">
                                    <span class="text-[9px] font-bold text-slate-400 uppercase">${date} ‚Ä¢ ${course}</span>
                                    <span class="text-[9px] font-bold text-slate-300 uppercase">${category}</span>
                                </div>
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2 w-[40%]">
                                        <span class="font-bold text-[10px] ${isEvW ? 'text-blue-700' : 'text-slate-400'}">EVAN</span>
                                        <span class="text-xl font-black ${isEvW ? 'text-slate-900' : 'text-slate-300'}">${evanS} <span class="text-[9px] font-medium text-slate-400">(${evanH})</span></span>
                                    </div>
                                    <span class="text-slate-200 italic font-bold text-[10px] w-[10%] text-center">VS</span>
                                    <div class="flex items-center justify-end gap-2 w-[40%] text-right">
                                        <span class="text-xl font-black ${isStW ? 'text-slate-900' : 'text-slate-300'}"><span class="text-[9px] font-medium text-slate-400">(${steveH})</span> ${steveS}</span>
                                        <span class="font-bold text-[10px] ${isStW ? 'text-emerald-700' : 'text-slate-400'}">STEVE</span>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                });
                standingsEl.innerHTML = `<span class="bg-blue-600 px-2 py-0.5 rounded shadow-sm text-white">Wins: ${evWins}</span><span class="bg-emerald-600 px-2 py-0.5 rounded shadow-sm text-white">Wins: ${stWins}</span>`;
            } catch (e) { container.innerHTML = `<p class="text-center text-red-500">Error loading scores.</p>`; }
        }

        fetchOverallDetails();
        fetchMatchResults();
    </script>
</body>
</html>
